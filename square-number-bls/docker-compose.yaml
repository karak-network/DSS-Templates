services:
    anvil:
        image: ghcr.io/foundry-rs/foundry:nightly
        platform: linux/amd64
        ports:
            - "8545:8545"
        volumes:
            - ./:/dss
        environment:
            - ANVIL_IP_ADDR=0.0.0.0
        working_dir: /dss/contracts
        command: anvil --no-cors

    contract-builder:
        image: node:22.5-slim
        platform: linux/amd64
        volumes:
            - ./:/dss
        working_dir: /dss/contracts
        depends_on:
            - anvil
        entrypoint:
            - /bin/sh
            - -c
            - |
              sleep 3 &&
              yarn &&
              echo "success" > /dss/builder.status

    contract-deployer:
        image: ghcr.io/foundry-rs/foundry:nightly
        platform: linux/amd64
        volumes:
            - ./:/dss
        working_dir: /dss/contracts
        depends_on:
            - anvil
        entrypoint:
            - /bin/sh
            - -c
            - |
              while [ ! -f /dss/builder.status ] || [ $(cat /dss/builder.status) != 'success' ]; do
              echo 'Waiting for contract-builder to complete...';
              sleep 2;
              done &&
              forge script script/deploy.sol --rpc-url http://anvil:8545 --private-key 0xac0974bec39a17e36ba4a6b4d238ff944bacb478cbed5efcae784d7bf4f2ff80 --broadcast --skip-simulation &&
              rm /dss/builder.status &&
              echo "success" > /dss/deploy.status

    aggregator:
        image: square-number-dss-aggregator
        build:
            context: .
            dockerfile: aggregator/Dockerfile
        platform: linux/amd64
        volumes:
            - ./:/dss
        ports:
            - "3000:3000"
        healthcheck:
            test: [ "CMD", "curl", "-f", "http://localhost:3000/health" ]
            interval: 30s
            timeout: 10s
            retries: 20
            start_period: 10s
        environment:
            - PORT=3000
            - HOST=0.0.0.0
            - HEARTBEAT=5000
            - RPC_URL=http://anvil:8545
            - CORS_ORIGIN=*
            - COMMON_RATE_LIMIT_WINDOW_MS=1000
            - COMMON_RATE_LIMIT_MAX_REQUESTS=10000
            - PRIVATE_KEY=0x59c6995e998f97a5a0044966f0945389dc9e86dae88c7a8412f4603b6b78690d
            - BLOCK_NUMBER_STORE=/dss/contracts/contract-addresses.json
            - RUST_LOG=info
            - SQUARE_NUMBER_DSS_ADDRESS=0x68B1D87F95878fE05B998F19b66F4baba5De1aed
            - CORE_ADDRESS=0x94099942864EA81cCF197E9D71ac53310b1468D8
        entrypoint: >
            sh -c " while [ ! -f /dss/deploy.status ] || [ \$(cat /dss/deploy.status) != 'success' ]; do echo 'Waiting for contract-deployer to complete...'; sleep 2; done && /app/square-number-dss-aggregator "

    operator-1:
        image: square-number-dss-operator
        build:
            context: .
            dockerfile: operator/Dockerfile
        platform: linux/amd64
        ports:
            - "8081:9177"
        environment:
            - DOMAIN_URL=http://operator-1:9177
            - RPC_URL=http://anvil:8545
            - CORS_ORIGIN=*
            - COMMON_RATE_LIMIT_WINDOW_MS=1000
            - COMMON_RATE_LIMIT_MAX_REQUESTS=10000
            - AGGREGATOR_URL=http://aggregator:3000
            - HEARTBEAT=5000
            - PRIVATE_KEY=0x5de4111afa1a4b94908f83103eb1f1706367c2e68ca870fc3fb9a804cdab365a
            - RUST_LOG=info
            - SQUARE_NUMBER_DSS_ADDRESS=0x68B1D87F95878fE05B998F19b66F4baba5De1aed
            - CORE_ADDRESS=0x94099942864EA81cCF197E9D71ac53310b1468D8
            - BLS_KEYPAIR=xyEvqRzNolRTApqFbBGkD+pdeueMDr5EIi+sb+2BZyM=
        depends_on:
            aggregator:
                condition: service_healthy
    operator-2:
        image: square-number-dss-operator
        build:
            context: .
            dockerfile: operator/Dockerfile
        platform: linux/amd64
        ports:
            - "8082:9177"
        environment:
            - DOMAIN_URL=http://operator-2:9177
            - RPC_URL=http://anvil:8545
            - CORS_ORIGIN=*
            - COMMON_RATE_LIMIT_WINDOW_MS=1000
            - COMMON_RATE_LIMIT_MAX_REQUESTS=10000
            - AGGREGATOR_URL=http://aggregator:3000
            - HEARTBEAT=5000
            - PRIVATE_KEY=0x7c852118294e51e653712a81e05800f419141751be58f605c371e15141b007a6
            - RUST_LOG=info
            - SQUARE_NUMBER_DSS_ADDRESS=0x68B1D87F95878fE05B998F19b66F4baba5De1aed
            - CORE_ADDRESS=0x94099942864EA81cCF197E9D71ac53310b1468D8
            - BLS_KEYPAIR=OlG7qeqEnGXAVjgxj38XRk9yB3Vd9mbaoX5bckostQg=
        depends_on:
            aggregator:
                condition: service_healthy
